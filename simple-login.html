<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单登录测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 300px;
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tabs button {
            flex: 1;
            padding: 10px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }
        .tabs button.active {
            background: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        #error-message {
            color: red;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>用户登录</h2>
        
        <!-- 模式切换 -->
        <div class="tabs">
            <button id="login-mode" class="active">登录</button>
            <button id="register-mode">注册</button>
        </div>
        
        <div id="error-message"></div>
        
        <!-- 登录表单 -->
        <div id="login-form-container" class="tab-content active">
            <!-- 登录方式切换 -->
            <div class="tabs">
                <button id="phone-tab-btn" data-tab="phone" class="active">手机号</button>
                <button id="email-tab-btn" data-tab="email">邮箱</button>
                <button id="wechat-tab-btn" data-tab="wechat">微信</button>
            </div>
            
            <!-- 手机登录 -->
            <div id="phone-tab" class="tab-content active">
                <div class="form-group">
                    <label for="phone">手机号</label>
                    <input type="tel" id="phone" placeholder="请输入手机号">
                </div>
                <div class="form-group">
                    <label for="sms-code">验证码</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="sms-code" placeholder="请输入验证码" style="flex: 1;">
                        <button id="get-sms" style="flex: 0 0 auto;">获取验证码</button>
                    </div>
                </div>
                <button id="phone-login-btn">登录</button>
            </div>
            
            <!-- 邮箱登录 -->
            <div id="email-tab" class="tab-content">
                <div class="form-group">
                    <label for="email">邮箱</label>
                    <input type="email" id="email" placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label for="email-password">密码</label>
                    <input type="password" id="email-password" placeholder="请输入密码">
                </div>
                <button id="email-login-btn">登录</button>
            </div>
            
            <!-- 微信登录 -->
            <div id="wechat-tab" class="tab-content">
                <button id="wechat-login-btn" style="margin-top: 40px;">微信扫码登录</button>
            </div>
        </div>
        
        <!-- 注册表单 -->
        <div id="register-form-container" class="tab-content">
            <!-- 注册方式切换 -->
            <div class="tabs">
                <button id="register-phone-tab-btn" data-tab="register-phone" class="active">手机号注册</button>
                <button id="register-email-tab-btn" data-tab="register-email">邮箱注册</button>
            </div>
            
            <!-- 手机注册 -->
            <div id="register-phone-tab" class="tab-content active">
                <div class="form-group">
                    <label for="register-phone">手机号</label>
                    <input type="tel" id="register-phone" placeholder="请输入手机号">
                </div>
                <div class="form-group">
                    <label for="register-sms-code">验证码</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="register-sms-code" placeholder="请输入验证码" style="flex: 1;">
                        <button id="register-get-sms" style="flex: 0 0 auto;">获取验证码</button>
                    </div>
                </div>
                <button id="phone-register-btn">注册</button>
            </div>
            
            <!-- 邮箱注册 -->
            <div id="register-email-tab" class="tab-content">
                <div class="form-group">
                    <label for="register-email">邮箱</label>
                    <input type="email" id="register-email" placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label for="register-password">密码</label>
                    <input type="password" id="register-password" placeholder="请设置密码">
                </div>
                <div class="form-group">
                    <label for="register-confirm-password">确认密码</label>
                    <input type="password" id="register-confirm-password" placeholder="请确认密码">
                </div>
                <button id="email-register-btn">注册</button>
            </div>
        </div>
    </div>

    <!-- 引入Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 引入Supabase配置和工具 -->
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase.js"></script>

    <script>
        // 极简版登录功能测试脚本
        console.log('简单登录测试脚本加载');
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，开始绑定事件');
            
            // 登录/注册模式切换
            document.getElementById('login-mode').addEventListener('click', function() {
                console.log('点击登录模式');
                document.getElementById('login-form-container').classList.add('active');
                document.getElementById('register-form-container').classList.remove('active');
                this.classList.add('active');
                document.getElementById('register-mode').classList.remove('active');
            });
            
            document.getElementById('register-mode').addEventListener('click', function() {
                console.log('点击注册模式');
                document.getElementById('login-form-container').classList.remove('active');
                document.getElementById('register-form-container').classList.add('active');
                this.classList.add('active');
                document.getElementById('login-mode').classList.remove('active');
            });
            
            // 登录方式切换
            document.getElementById('phone-tab-btn').addEventListener('click', function() {
                console.log('点击手机登录');
                switchLoginTab('phone');
            });
            
            document.getElementById('email-tab-btn').addEventListener('click', function() {
                console.log('点击邮箱登录');
                switchLoginTab('email');
            });
            
            document.getElementById('wechat-tab-btn').addEventListener('click', function() {
                console.log('点击微信登录');
                switchLoginTab('wechat');
            });
            
            // 注册方式切换
            document.getElementById('register-phone-tab-btn').addEventListener('click', function() {
                console.log('点击手机注册');
                switchRegisterTab('register-phone');
            });
            
            document.getElementById('register-email-tab-btn').addEventListener('click', function() {
                console.log('点击邮箱注册');
                switchRegisterTab('register-email');
            });
            
            // 登录按钮
            document.getElementById('phone-login-btn').addEventListener('click', function() {
                console.log('点击手机登录按钮');
                handlePhoneLogin();
            });
            
            document.getElementById('email-login-btn').addEventListener('click', function() {
                console.log('点击邮箱登录按钮');
                handleEmailLogin();
            });
            
            document.getElementById('wechat-login-btn').addEventListener('click', function() {
                console.log('点击微信登录按钮');
                alert('微信登录功能暂未实现');
            });
            
            // 注册按钮
            document.getElementById('phone-register-btn').addEventListener('click', function() {
                console.log('点击手机注册按钮');
                handlePhoneRegister();
            });
            
            document.getElementById('email-register-btn').addEventListener('click', function() {
                console.log('点击邮箱注册按钮');
                handleEmailRegister();
            });
            
            // 验证码按钮
            document.getElementById('get-sms').addEventListener('click', function() {
                console.log('点击获取登录验证码');
                handleGetSMS();
            });
            
            document.getElementById('register-get-sms').addEventListener('click', function() {
                console.log('点击获取注册验证码');
                handleGetRegisterSMS();
            });
            
            console.log('事件绑定完成');
        });
        
        // 切换登录标签页
        function switchLoginTab(tabName) {
            // 隐藏所有登录标签页
            document.getElementById('phone-tab').classList.remove('active');
            document.getElementById('email-tab').classList.remove('active');
            document.getElementById('wechat-tab').classList.remove('active');
            
            // 移除所有按钮激活状态
            document.getElementById('phone-tab-btn').classList.remove('active');
            document.getElementById('email-tab-btn').classList.remove('active');
            document.getElementById('wechat-tab-btn').classList.remove('active');
            
            // 显示选中的标签页并激活按钮
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById(tabName + '-tab-btn').classList.add('active');
        }
        
        // 切换注册标签页
        function switchRegisterTab(tabName) {
            // 隐藏所有注册标签页
            document.getElementById('register-phone-tab').classList.remove('active');
            document.getElementById('register-email-tab').classList.remove('active');
            
            // 移除所有按钮激活状态
            document.getElementById('register-phone-tab-btn').classList.remove('active');
            document.getElementById('register-email-tab-btn').classList.remove('active');
            
            // 显示选中的标签页并激活按钮
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById(tabName + '-tab-btn').classList.add('active');
        }
        
        // 邮箱登录处理
        async function handleEmailLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('email-password').value;
            
            if (!email || !password) {
                showError('请输入邮箱和密码');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.signIn(email, password);
                    if (result.success) {
                        showSuccess('登录成功！');
                        console.log('登录用户:', result.user);
                        // 3秒后跳转到主页面
                        setTimeout(() => {
                            window.location.href = 'main.html';
                        }, 2000);
                    } else {
                        showError('登录失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('登录异常:', error);
                showError('登录异常，请稍后重试');
            }
        }
        
        // 邮箱注册处理
        async function handleEmailRegister() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            if (!email || !password || !confirmPassword) {
                showError('请填写所有必填字段');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('两次输入的密码不一致');
                return;
            }
            
            if (password.length < 6) {
                showError('密码长度至少6位');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.signUp(email, password, {
                        name: email.split('@')[0]
                    });
                    if (result.success) {
                        showSuccess('注册成功！请查收邮箱验证邮件');
                        console.log('注册用户:', result.user);
                        // 3秒后切换到登录模式
                        setTimeout(() => {
                            document.getElementById('login-mode').click();
                        }, 3000);
                    } else {
                        showError('注册失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('注册异常:', error);
                showError('注册异常，请稍后重试');
            }
        }
        
        // 手机登录处理
        async function handlePhoneLogin() {
            const phone = document.getElementById('phone').value;
            const code = document.getElementById('sms-code').value;
            
            if (!phone || !code) {
                showError('请输入手机号和验证码');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.signInWithPhone(phone, code);
                    if (result.success) {
                        showSuccess('手机登录成功！');
                        console.log('登录用户:', result.user);
                        // 3秒后跳转到主页面
                        setTimeout(() => {
                            window.location.href = 'main.html';
                        }, 2000);
                    } else {
                        showError('手机登录失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('手机登录异常:', error);
                showError('手机登录异常，请稍后重试');
            }
        }
        
        // 手机注册处理
        async function handlePhoneRegister() {
            const phone = document.getElementById('register-phone').value;
            const code = document.getElementById('register-sms-code').value;
            
            if (!phone || !code) {
                showError('请输入手机号和验证码');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    // 先验证验证码
                    const verifyResult = await window.Supabase.auth.verifyPhoneCode(phone, code);
                    if (verifyResult.success) {
                        // 验证码验证成功后创建用户
                        const result = await window.Supabase.auth.signUp(phone + '@phone.com', 'default123', {
                            name: '手机用户',
                            phone: phone
                        });
                        if (result.success) {
                            showSuccess('手机注册成功！');
                            console.log('注册用户:', result.user);
                            // 3秒后切换到登录模式
                            setTimeout(() => {
                                document.getElementById('login-mode').click();
                            }, 3000);
                        } else {
                            showError('注册失败: ' + (result.error || '未知错误'));
                        }
                    } else {
                        showError('验证码验证失败: ' + (verifyResult.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('手机注册异常:', error);
                showError('手机注册异常，请稍后重试');
            }
        }
        
        // 获取验证码
        async function handleGetSMS() {
            const phone = document.getElementById('phone').value;
            if (!phone) {
                showError('请输入手机号');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.sendPhoneVerification(phone);
                    if (result.success) {
                        showSuccess('验证码已发送，请注意查收');
                        console.log('验证码:', result.code); // 开发环境显示验证码
                    } else {
                        showError('发送验证码失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('发送验证码异常:', error);
                showError('发送验证码异常，请稍后重试');
            }
        }
        
        // 获取注册验证码
        async function handleGetRegisterSMS() {
            const phone = document.getElementById('register-phone').value;
            if (!phone) {
                showError('请输入手机号');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.sendPhoneVerification(phone);
                    if (result.success) {
                        showSuccess('验证码已发送，请注意查收');
                        console.log('验证码:', result.code); // 开发环境显示验证码
                    } else {
                        showError('发送验证码失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('发送验证码异常:', error);
                showError('发送验证码异常，请稍后重试');
            }
        }
        
        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.color = 'red';
            errorElement.style.display = 'block';
        }
        
        // 显示成功信息
        function showSuccess(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.color = 'green';
            errorElement.style.display = 'block';
        }
        
        // 邮箱登录处理
        async function handleEmailLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('email-password').value;
            
            if (!email || !password) {
                showError('请输入邮箱和密码');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.signIn(email, password);
                    if (result.success) {
                        showSuccess('登录成功！');
                        console.log('登录用户:', result.user);
                        // 3秒后跳转到主页面
                        setTimeout(() => {
                            window.location.href = 'main.html';
                        }, 2000);
                    } else {
                        showError('登录失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('登录异常:', error);
                showError('登录异常，请稍后重试');
            }
        }
        
        // 邮箱注册处理
        async function handleEmailRegister() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            if (!email || !password || !confirmPassword) {
                showError('请填写所有必填字段');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('两次输入的密码不一致');
                return;
            }
            
            if (password.length < 6) {
                showError('密码长度至少6位');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.signUp(email, password, {
                        name: email.split('@')[0]
                    });
                    if (result.success) {
                        showSuccess('注册成功！请查收邮箱验证邮件');
                        console.log('注册用户:', result.user);
                        // 3秒后切换到登录模式
                        setTimeout(() => {
                            document.getElementById('login-mode').click();
                        }, 3000);
                    } else {
                        showError('注册失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('注册异常:', error);
                showError('注册异常，请稍后重试');
            }
        }
        
        // 手机登录处理
        async function handlePhoneLogin() {
            const phone = document.getElementById('phone').value;
            const code = document.getElementById('sms-code').value;
            
            if (!phone || !code) {
                showError('请输入手机号和验证码');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.signInWithPhone(phone, code);
                    if (result.success) {
                        showSuccess('手机登录成功！');
                        console.log('登录用户:', result.user);
                        // 3秒后跳转到主页面
                        setTimeout(() => {
                            window.location.href = 'main.html';
                        }, 2000);
                    } else {
                        showError('手机登录失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('手机登录异常:', error);
                showError('手机登录异常，请稍后重试');
            }
        }
        
        // 手机注册处理
        async function handlePhoneRegister() {
            const phone = document.getElementById('register-phone').value;
            const code = document.getElementById('register-sms-code').value;
            
            if (!phone || !code) {
                showError('请输入手机号和验证码');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    // 先验证验证码
                    const verifyResult = await window.Supabase.auth.verifyPhoneCode(phone, code);
                    if (verifyResult.success) {
                        // 验证码验证成功后创建用户
                        const result = await window.Supabase.auth.signUp(phone + '@phone.com', 'default123', {
                            name: '手机用户',
                            phone: phone
                        });
                        if (result.success) {
                            showSuccess('手机注册成功！');
                            console.log('注册用户:', result.user);
                            // 3秒后切换到登录模式
                            setTimeout(() => {
                                document.getElementById('login-mode').click();
                            }, 3000);
                        } else {
                            showError('注册失败: ' + (result.error || '未知错误'));
                        }
                    } else {
                        showError('验证码验证失败: ' + (verifyResult.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('手机注册异常:', error);
                showError('手机注册异常，请稍后重试');
            }
        }
        
        // 获取验证码
        async function handleGetSMS() {
            const phone = document.getElementById('phone').value;
            if (!phone) {
                showError('请输入手机号');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.sendPhoneVerification(phone);
                    if (result.success) {
                        showSuccess('验证码已发送，请注意查收');
                        console.log('验证码:', result.code); // 开发环境显示验证码
                    } else {
                        showError('发送验证码失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('发送验证码异常:', error);
                showError('发送验证码异常，请稍后重试');
            }
        }
        
        // 获取注册验证码
        async function handleGetRegisterSMS() {
            const phone = document.getElementById('register-phone').value;
            if (!phone) {
                showError('请输入手机号');
                return;
            }
            
            try {
                if (window.Supabase && window.Supabase.auth) {
                    const result = await window.Supabase.auth.sendPhoneVerification(phone);
                    if (result.success) {
                        showSuccess('验证码已发送，请注意查收');
                        console.log('验证码:', result.code); // 开发环境显示验证码
                    } else {
                        showError('发送验证码失败: ' + (result.error || '未知错误'));
                    }
                } else {
                    showError('Supabase服务不可用，请检查网络连接');
                }
            } catch (error) {
                console.error('发送验证码异常:', error);
                showError('发送验证码异常，请稍后重试');
            }
        }
        
        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.color = 'red';
            errorElement.style.display = 'block';
        }
        
        // 显示成功信息
        function showSuccess(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.color = 'green';
            errorElement.style.display = 'block';
        }
    </script>
</body>
</html>